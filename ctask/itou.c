#include "stdio.h"
#include <stdint.h>
#include <stddef.h>
#include <string.h>
#include <math.h>



char currentTime[] = {
	
	//, 1   
	//, 3 
	/*  
	, -16 
	, 3   
	, 0   
	, 1   
	, 0   
	, 36  
	, 0   
	, 17  
	, 0   
	, 32 
	*/ 
	//,
	  84  
	, 80  
	, 34  
	, -23 
	, -10 
	, -55 
	, -61 
	, -7  
      
	//, 2   
	//, 3   
	, 121 
	, -48 
	, -39 
	, 123 
	, -104
	, 54  
	, -14 
	, -46 
	, -99 
	, 104 
	, -76 
	, 65  
	, 122 
	, 117 
	, 21  
	, -88 
	, -15 
	, -97 
      
	//, 3   
	//, 3   
	, 2   
	, -15 
	, 123 
	, 102 
	, -12 
	, 113 
	, -118
	, -19 
	
};

unsigned char roche_seed[] = {
        //0x01, 0x01,
	0x83, 0x01,
	0x00, 0x01,
    0x00, 0x06,
    0x00, 0x03, 0x00, 0x02,  0x00, 0x03, 0x6C, 0x41
};

unsigned char roche_key_demo[] = {
	
	 // 0x01, 0x03, 
	 0xf0, 0x03 , 0x00, 0x01, 0x00, 0x24
	, 0x00, 0x11, 0x00, 0x20 
		 
	, 0x00, 0x00, 0x00, 0x00 
	, 0x00, 0x00, 0x00, 0x00
	//, 0x02, 0x03
	, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	, 0x00, 0x00, 0x00, 0x00
	, 0x00, 0x00, 0x00, 0x00 
	, 0x00, 0x00, 0x00, 0x00
	//, 0x03, 0x03
	, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00 
	, 0x14, 0x81
	/*	 
	 	 // 0x01, 0x03, 
	 	0xf0, 0x03 , 0x00, 0x01, 0x00, 0x24
	 	, 0x00, 0x11, 0x00, 0x20 , 0x6e, 0xec, 0x0c, 0x43 
	 	, 0x40, 0xd6, 0xe3, 0xf0
	 	//, 0x02, 0x03
	 	, 0xae, 0x93 , 0xf2, 0x95, 0xfc, 0x65 
	 	, 0xeb, 0xe7, 0xf6, 0xc2 , 0x15, 0x51, 0x5d, 0x5c 
	 	, 0xb0, 0x46, 0x96, 0xf6
	 	//, 0x03, 0x03
	 	, 0x73, 0x49 , 0x9b, 0xa6, 0x47, 0xfd 
	 	, 0x14, 0x81	 
		*/
};

unsigned char wrCurrentTime[] = {
	  0x88, 0x92 , 0x00, 0x04, 0x00, 0x20
	//, 0x09, 0x90, 0x00, 0x08 , 0x20, 0x19, 0x02, 0x18
	//	  , 0x09, 0x90, 0x00, 0x08 , 0x20, 0x17, 0x03, 0x23
	//, 0x17, 0x09, 0x49, 0x97
			  
			  , 0x09, 0x90, 0x00, 0x08 , 0x20, 0x30, 0x03, 0x04
			  , 0x17, 0x48//, 0x43, 0x88 
			  , 0x11, 0x22 
					
						
			  , 0x00, 0x1c, 0x00, 0x04
			  , 0x00, 0x00, 0x00, 0x00 , 0x00, 0x10, 0x00, 0x02
			  , 0x00, 0x00, 0x00, 0x03 , 0x00, 0x02
			
			, 0x00, 0x05
			  , 0xa7, 0xf0
								
		//, 0x00, 0x1c , 0x00, 0x04, 0x00, 0x00
		//, 0x00, 0x00, 0x00, 0x10 , 0x00, 0x02, 0x00, 0x00
		//, 0x00, 0x03, 0x00, 0x02
									
		//, 0x00, 0x05
		//, 0xAA, 0x88
};

unsigned char config[] = {
    //0x01, 0x0F, 
	0x83, 0x02 , 0x00, 0x01, 0x01, 0x04 
  , 0x00, 0x11, 0x01, 0x00 , 0x0C, 0x3D, 0xB9, 0x00
  , 0x31, 0x53, 0x14, 0x16

    //0x02, 0x0F
, 0xB8, 0xB0 , 0x74, 0xFE, 0x9C, 0xD1 
  , 0xFE, 0x83, 0xC5, 0xE1 , 0x81, 0x4E, 0x8B, 0x72
  , 0x8D, 0x8A, 0xE5, 0xCF

    //0x03, 0x0F
	, 0x7A, 0x69 , 0x4A, 0xF4, 0x3D, 0x55
  , 0xA0, 0xFE, 0xE9, 0x05 , 0xA8, 0x58, 0xD1, 0xF4
  , 0x67, 0x40, 0xAB, 0x3E
  
  //0x04, 0x0F
, 0x43, 0x31 , 0xC9, 0xC1, 0x3D, 0x6B
, 0x99, 0x9E, 0xD8, 0xA2 , 0x83, 0x77, 0xC2, 0xB4
, 0x86, 0xAD, 0xE9, 0x48

  //0x05, 0x0F
, 0xB1, 0x03 , 0xA1, 0x3D, 0x7B, 0xCF
, 0xD9, 0xCC, 0xCE, 0xBC , 0xBF, 0xBC, 0xB1, 0x61
, 0xEC, 0x71, 0x9F, 0xFB

  //0x06, 0x0F
, 0xA0, 0xA4 , 0xF9, 0xEF, 0xB4, 0xCA  
, 0xF3, 0xAF, 0x66, 0x8D , 0x62, 0xE4, 0xB2, 0x60
, 0x8A, 0x9B, 0xA1, 0x44

  //0x07, 0x0F
, 0x6B, 0x6F , 0xF7, 0x94, 0x97, 0x29 
, 0xFA, 0x86, 0x63, 0xF4 , 0x4E, 0x3D, 0x3F, 0x1A
, 0xC1, 0xAD, 0x3D, 0x09

  //0x08, 0x0F
, 0xE5, 0xD7 , 0xB7, 0x11, 0x86, 0xEE
, 0x81, 0xD5, 0x9C, 0xD8 , 0x7D, 0x9C, 0x25, 0x76
, 0x04, 0xF0, 0x62, 0x6C

  //0x09, 0x0F
, 0x6B, 0x88 , 0xED, 0x17, 0xEE, 0x9E 
, 0x96, 0x83, 0x83, 0x37 , 0xFF, 0x00, 0x14, 0xCE
, 0xF6, 0x8F, 0x29, 0x4A

  //0x0A, 0x0E
, 0x3C, 0xEC , 0x57, 0x89, 0x67, 0x55 
, 0xC3, 0x67, 0xDF, 0x61 , 0x72, 0xE9, 0xFB, 0x65
, 0x8D, 0x99, 0x9D, 0x9B

  //0x0B, 0x0F
, 0xB9, 0xE0 , 0x36, 0x97, 0x0E, 0xFC
, 0x1B, 0x2A, 0xAA, 0xCB , 0x17, 0x79, 0xAE, 0x06
, 0xB7, 0xB9, 0x58, 0x53

  //0x0C, 0x0F
, 0xF5, 0x88 , 0xAC, 0xC4, 0x43, 0x8C
, 0x4D, 0x9A, 0x52, 0x02 , 0x33, 0xA7, 0xF0, 0x7E
, 0x15, 0x59, 0xEA, 0xB6

  //0x0D, 0x0F
, 0x38, 0x59 , 0x97, 0x24, 0xA7, 0x54 
, 0xB8, 0x9F, 0x6F, 0xDC , 0x30, 0x8A, 0x14, 0x0C
, 0xF3, 0x72, 0xDF, 0xC6

  //0x0E, 0x0F
, 0x8C, 0x9F , 0xF5, 0x86, 0x24, 0x26
, 0x10, 0x99, 0xE9, 0xD4 , 0x1C, 0x03, 0x0F, 0xAB
, 0xFA, 0xC8, 0xB4, 0x39

  //0x0F, 0x0F
, 0x27, 0xC2 , 0xFE, 0xC2, 0x8F, 0x72
, 0x92, 0xA6, 0x4B, 0x34 , 0x38, 0x52, 0x1F, 0xF4
, 0xB1, 0x3F	
};

unsigned char configX[] = {
	0x83, 0x02 , 0x00, 0x01, 0x01, 0x04                    
  , 0x00, 0x11, 0x01, 0x00 , 0x19, 0x79, 0x9d, 0xcc                    
  , 0x70, 0x86, 0x44, 0x3c , 0xc7, 0x92, 0x2b, 0x01                    
  , 0x0a, 0xd3, 0xd6, 0x69 , 0x63, 0xa5, 0x94, 0xad                    
  , 0x19, 0xbe, 0x3e, 0x14 , 0x2e, 0x27, 0x30, 0x82                    
  , 0xbf, 0x26, 0xba, 0x2b , 0x75, 0xd3, 0x28, 0x44                    
  , 0xb7, 0x8f, 0x49, 0x32 , 0xe4, 0xce, 0x80, 0x67                    
  , 0x10, 0x9a, 0xe1, 0x6c , 0xb2, 0xd7, 0x3a, 0x44                    
  , 0x44, 0xea, 0xb7, 0x1e , 0xed, 0x28, 0xc7, 0x36                    
  , 0xc0, 0xa6, 0x71, 0xbd , 0x1c, 0x5c, 0x28, 0xe4                    
  , 0xb7, 0xa9, 0x94, 0x27 , 0xbe, 0x2b, 0xbf, 0xdc                    
  , 0xd7, 0xdc, 0xdb, 0xa9 , 0xe2, 0x1d, 0xcd, 0xe6                    
  , 0x3b, 0x91, 0xd9, 0x8a , 0x1b, 0xdf, 0x83, 0xa4                    
  , 0x60, 0xb8, 0x4b, 0x29 , 0x38, 0xc9, 0xe7, 0xef                    
  , 0xc4, 0xd7, 0xf7, 0x7b , 0x66, 0xdf, 0xe1, 0x7d                    
  , 0x08, 0x2d, 0xdd, 0x7d , 0xf7, 0x1f, 0xfe, 0xbb                    
  , 0x67, 0x1e, 0x70, 0x2d , 0x5f, 0x0b, 0x53, 0xd0                    
  , 0x85, 0x88, 0x2c, 0x6e , 0xaf, 0xf2, 0x5d, 0x6a                    
  , 0x73, 0x7b, 0x6d, 0xf1 , 0x41, 0x2b, 0x1e, 0x87                    
  , 0xe5, 0x5c, 0x0d, 0xb0 , 0x6e, 0x53, 0x68, 0x8a                    
  , 0xe3, 0x32, 0xc1, 0x88 , 0xbc, 0xa0, 0x4a, 0x29                    
  , 0xaf, 0x43, 0xb6, 0x93 , 0xbf, 0x8e, 0xf6, 0xbc                    
  , 0x15, 0x4b, 0xf1, 0x86 , 0x9e, 0x82, 0x77, 0x9f                    
  , 0x22, 0xd6, 0x78, 0xb2 , 0xf3, 0xbf, 0xc2, 0xad                    
  , 0xae, 0x69, 0x70, 0xb8 , 0xf7, 0x83, 0x91, 0x1d                    
  , 0xbd, 0x21, 0xa6, 0xd4 , 0xf1, 0xdb, 0x8c, 0x97                    
  , 0xb0, 0x5e, 0x92, 0xa3 , 0x14, 0x6c, 0x5b, 0xe5                    
  , 0x13, 0x23, 0x0b, 0xe6 , 0x73, 0x0d, 0x0d, 0x97                    
  , 0x51, 0xb9, 0x80, 0x95 , 0x50, 0x93, 0x79, 0xda                    
  , 0x4a, 0xbf, 0xd9, 0x06 , 0x65, 0xa6, 0x46, 0x10                    
  , 0x23, 0x26, 0xc8, 0x44 , 0xba, 0x76, 0x05, 0xc4                    
  , 0xe2, 0x29, 0x63, 0xcb , 0x7a, 0xe0, 0x59, 0x11                    
  , 0xb4, 0xde, 0xee, 0x96 , 0x67, 0x74, 0x50, 0xd8                    
  , 0xa9, 0xba, 0xe8, 0x30 , 0xf3, 0xd0	
};


unsigned char config_ip[] = {
	//0x01, 0x0F,
	 0x83, 0x02 ,  0x00, 0x01, 0x01, 0x04,
	    0x00, 0x11, 0x01, 0x00 ,  0x98, 0x06, 0x16, 0x44,
	    0x2F, 0x50, 0xF2, 0x2F ,
    
	    //0x02, 0x0F, 
		0xE0, 0x43 , 0x45, 0xD3, 0xE8, 0x08 ,
	    0x26, 0x4A, 0x4A, 0xF6 , 0x12, 0x15, 0xA5, 0xE1 ,
	    0x7E, 0xFD, 0x99, 0xA9 ,
    
	    //0x03, 0x0F, 
		0x0A, 0xA0 , 0xE3, 0xE5, 0x8F, 0x71 ,
	    0x28, 0xB1, 0xA4, 0x7C , 0xA0, 0x90, 0xA1, 0x6A ,
	    0x40, 0x0B, 0xAF, 0x7F ,
    
	    //0x04, 0x0F, 
		0xF8, 0x80 , 0x13, 0x4E, 0x15, 0x98 ,
	    0xA4, 0x22, 0x36, 0x28 , 0x66, 0x6E, 0x27, 0xA5 ,
	    0x1D, 0x9D, 0x0D, 0xF7 ,
    
	    //0x05, 0x0F, 
		0xB0, 0x0E , 0x4D, 0xA8, 0xB9, 0x71 ,
	    0x30, 0xD8, 0xDD, 0x96 , 0x29, 0xA8, 0x6D, 0xC6 ,
	    0xCB, 0x25, 0xCC, 0x9B ,
    
	    //0x06, 0x0F, 
		0x0F, 0x30 , 0xB0, 0x4E, 0x34, 0x67 ,
	    0x7B, 0x71, 0x70, 0x8D , 0x37, 0xA6, 0xDB, 0x40 ,
	    0xBC, 0x7D, 0x29, 0x00 ,
    
	    //0x07, 0x0F, 
		0x5F, 0xA2 , 0xF4, 0xF6, 0x68, 0x20 ,
	    0x7E, 0x81, 0x5F, 0x4A , 0xB9, 0x9A, 0xC0, 0xDC ,
	    0x7D, 0xF4, 0xD2, 0x86 ,
    
	    //0x08, 0x0F, 
		0x17, 0xC8 , 0x08, 0xFC, 0x25, 0x1F ,
	    0x48, 0xFE, 0x63, 0x9E , 0x07, 0xAA, 0x07, 0x85 ,
	    0x2C, 0x67, 0x22, 0xA2 ,
    
	    //0x09, 0x0F, 
		0x8B, 0x3C , 0x02, 0xDF, 0x77, 0x1F ,
	    0x28, 0x8A, 0xD5, 0xF8 , 0xBF, 0x37, 0x6E, 0x2B ,
	    0xFE, 0xA2, 0x55, 0x08 ,
    
	    //0x0A, 0x0F, 
		0x42, 0xD4 , 0x89, 0x2A, 0x33, 0x10 ,
	    0x29, 0x17, 0xF0, 0xD9 , 0xC2, 0xD5, 0xA2, 0x90 ,
	    0x43, 0xA5, 0x28, 0x28 ,
    
	    //0x0B, 0x0F, 
		0xC9, 0xB1 , 0xFF, 0xDB, 0x6F, 0xE5 ,
	    0xB3, 0x29, 0xDA, 0xE9 , 0x40, 0x51, 0x46, 0x0B ,
	    0x23, 0x4B, 0xF4, 0x60 ,
    
	    //0x0C, 0x0F, 0x34, 0x6A , 0xAE, 0x22, 0xA7, 0xA4 ,
	    0x30, 0x83, 0xDD, 0x85 , 0x4C, 0xB3, 0xD8, 0xB6 ,
	    0x33, 0x1F, 0xF8, 0x49 ,
    
	    //0x0D, 0x0F, 
		0x01, 0x20 , 0x8F, 0x76, 0x04, 0x27 ,
	    0x5F, 0x20, 0x47, 0x35 , 0x44, 0x5E, 0x13, 0x58 ,
	    0x8F, 0x4F, 0x32, 0x30 ,
    
	    //0x0E, 0x0F, 
		0xE9, 0x14 , 0x3A, 0x22, 0x69, 0xC9 ,
	    0x32, 0x72, 0x8F, 0xA0 , 0xC0, 0x3F, 0x9E, 0x06 ,
	    0xA2, 0xC1, 0xEA, 0x54 
			
			//0x0F, 0x0F
			, 0x05, 0x63 , 0x72, 0x04, 0xB4, 0xF5 ,
			    0x8F, 0xAB, 0x92, 0x32 , 0xC4, 0x7B, 0xF2, 0x34 ,
			    0xE4, 0x17	
};

typedef struct {
	int coef;
	int power;
} ITEM;

ITEM formula[10];
	
uint16_t crc16_mcrf4xx(uint16_t crc, uint8_t *data, size_t len);
int curl_test(int seed);
void initFormula(void);
void diffFormula(void);
	
int main() {
	printf("=== A %04X === \n", -53);
	printf("=== B %04X === \n", -111);
	printf("=== C %04X === \n", -109);
	
	printf("=== X %04X === \n", -4093);
	printf("=== Y %04X === \n", -125);
	
	
	
	printf("\n======= CT =======\n");
	for (int i=0; i<sizeof(currentTime); i++) {
		printf("%d, %02d, 0x%02X\n", i, currentTime[i], currentTime[i]);
	}
	printf("how do!!\n");
	
	uint16_t crc_init = 0xFFFF;
	
	printf("\n");
	printf("=========================\n");
	uint16_t crcRocheTmp = crc16_mcrf4xx(crc_init, wrCurrentTime, sizeof(wrCurrentTime) - 2);
	printf("=== CURRENT CRC %04X ===\n", crcRocheTmp);
	printf("\n");	
	
	printf("\n");
	crcRocheTmp = crc16_mcrf4xx(crc_init, roche_key_demo, sizeof(roche_key_demo) - 2);
	printf("=== DEMO CRC %04X ===\n", crcRocheTmp);
	printf("\n");
	
	
	crcRocheTmp = crc16_mcrf4xx(crc_init, config, sizeof(config) - 2);
	printf("=== CFG CRC %04X ===\n", crcRocheTmp);
	
	crcRocheTmp = crc16_mcrf4xx(crc_init, configX, sizeof(configX) - 2);
	printf("=== CFG XXX CRC %04X ===\n", crcRocheTmp);
	
	
	printf("\n");
	crcRocheTmp = crc16_mcrf4xx(crc_init, config_ip, sizeof(config_ip) - 2);
	printf("=== CFG XYZ CRC %04X ===\n", crcRocheTmp);
	printf("\n");
		
	int totalLen = sizeof(configX)/sizeof(configX[0]);
	unsigned char segment = totalLen / 18;
	unsigned char cfgMod = totalLen % 18;
	printf("=== CFG SEGMENT === %d\n", segment);
	if (cfgMod != 0) {
		segment++;
	}
	
	printf("=== CFG SEGMENT === %d\n", segment);
	unsigned char temp[20] = {255};
	for(int i=0; i<segment-1; i++) {
		temp[0] = i+1;
		temp[1] = segment;
		memcpy(&temp[2], &configX[i*18],18);
		printf("=== SEGMENT === %02d ", i+1);
		for(int k=0; k<20; k++)
		printf(" %02x ", temp[k]);
		printf("\n");
	}
	
	if (cfgMod != 0) {
		temp[0] = segment;
		temp[1] = segment;
		memcpy(&temp[2], &configX[(segment-1)*18], cfgMod);
		printf("=== SEGMENT === %02d ", segment);
		for(int k=0; k<20; k++)
		printf(" %02x ", temp[k]);
		printf("\n");
	}
	
	//int val = curl_test(9);
	printf("\n");
	//printf("THE VAL = %d \n", val);
	
	initFormula();
	printf("\n");
	diffFormula();
	printf("\n");
	diffFormula();
	printf("\n");
	diffFormula();
	printf("\n");
	
	printf("\n");
	printf("== ELS = %f, ==\n", cos(1.7));
	
	return 0;
}



uint16_t crc16_mcrf4xx(uint16_t crc, uint8_t *data, size_t len)
{
    if (!data || len < 0)
        return crc;

    while (len--) {
        crc ^= *data++;
        for (int i=0; i<8; i++) {
            if (crc & 1)  crc = (crc >> 1) ^ 0x8408;
            else          crc = (crc >> 1);
        }
    }
    return crc;
}

void initFormula(void) {
	for(int i=0; i<sizeof(formula)/sizeof(formula[0]); i++) {
		//printf("ST LEN = %02d, %02d \n", (int)sizeof(formula), (int)sizeof(formula[0]));
		printf("ST VAL = %02d, %02d \n", formula[i].coef, formula[i].power);
	}
	int itemLen = sizeof(formula)/sizeof(formula[0]);
	itemLen--;
	formula[0].coef = 3;
	formula[0].power = 9;
	
	formula[itemLen-3].coef = 5;
	formula[itemLen-3].power = 3;
	
	formula[itemLen-2].coef = 3;
	formula[itemLen-2].power = 2;
	
	formula[itemLen-1].coef = 3;
	formula[itemLen-1].power = 1;
	
	formula[itemLen-0].coef = 6;
	formula[itemLen-0].power = 0;
	for(int i=0; i<sizeof(formula)/sizeof(formula[0]); i++) {
		//printf("ST LEN = %02d, %02d \n", (int)sizeof(formula), (int)sizeof(formula[0]));
		printf("INIT VAL = %02d, %02d \n", formula[i].coef, formula[i].power);
	}
}

void diffFormula(void) {
	int itemLen = sizeof(formula)/sizeof(formula[0]);
	
	/*
	for(int m=itemLen; m>0; m--) {
		
		formula[m].coef = formula[m-1].coef * formula[m-1].power;
		
		if (formula[m-1].power > 0) {
			formula[m].power = (formula[m-1].power--);
		}else {
			formula[m-1].power = 0;
			formula[m-1].power = 0;
		}
		//printf("ST VAL = %02d : %02d, %02d \n", m, formula[m-1].coef, formula[m-1].power);
	}*/
	
	for(int m=0; m<itemLen; m++) {
		formula[m].coef *= formula[m].power;
		if(formula[m].power > 0) {
			formula[m].power--;
		}
	}
	
	for(int m=itemLen-1; m>0; m--) {
		formula[m].coef = formula[m-1].coef;
		formula[m].power = formula[m-1].power;
		
	}
	
	formula[0].coef = 0;
	formula[0 ].power = 0;
	
	
	for(int m=0; m<itemLen; m++) {
		printf("ST VAL = %02d : %02d, %02d \n", m, formula[m].coef, formula[m].power);
	}
	
	
}


int curl_test(int seed)
{
	printf("THE SEED = %d \n", seed);
	
	float x = 1.3;
	printf("THE TX = %f", (x*x*x + 3 * x + 2));
	if(seed < 1) return 0;
	int xval = 0;
	if((seed%2) != 0){
		xval = curl_test(seed-1);
	}else{
		xval = curl_test(seed-2);
	}
	
	printf("THE VAL IN = %d \n", xval);
	//return (curl_test(seed-1)/curl_test(seed-2));
	return curl_test(seed-1);
	//return (curl_test(seed) * curl_test(seed-1));
}

